name: üßπ Clean Duplicates and Normalize Encoding

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y dos2unix python3

      - name: Remove duplicate files and normalize encoding
        run: |
          echo "Scanning repository for duplicate files..."
          # –°—á–∏—Ç–∞–µ–º —Ö—ç—à–∏ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —Ç–æ—á–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã
          mapfile -t files < <(find . -type f ! -path "./.git/*" ! -path "./.github/*")
          declare -A seen
          for f in "${files[@]}"; do
            if [[ -f "$f" ]]; then
              hash=$(sha256sum "$f" | awk '{print $1}')
              if [[ -n "${seen[$hash]}" ]]; then
                echo "üóë Deleting duplicate: $f"
                rm -f "$f"
              else
                seen[$hash]="$f"
              fi
            fi
          done

          echo "Normalizing file encodings to UTF-8..."
          # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã –≤ UTF-8 –±–µ–∑ BOM
          for f in $(find . -type f ! -path "./.git/*" ! -path "./.github/*" -name "*.txt" -o -name "*.md" -o -name "*.html" -o -name "*.js" -o -name "*.css" -o -name "*.yml" -o -name "*.yaml" -o -name "*.json"); do
            if file -i "$f" | grep -q "charset="; then
              iconv -f "$(file -bi "$f" | sed -n 's/.*charset=//p')" -t utf-8 "$f" -o "${f}.tmp" 2>/dev/null || cp "$f" "${f}.tmp"
              dos2unix "${f}.tmp" 2>/dev/null || true
              mv "${f}.tmp" "$f"
            fi
          done

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "chore: remove duplicate files and normalize encoding"
            git push
            echo "‚úÖ Cleanup complete and committed."
          else
            echo "‚ÑπÔ∏è No changes to commit."
          fi
