name: cleanup

on:
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Remove duplicate files and fix encoding
        run: |
          sudo apt-get update -y
          sudo apt-get install -y dos2unix
          python3 - <<'PY'
import os, hashlib, chardet, pathlib
root = pathlib.Path(".")
seen = {}
deleted = 0
converted = 0
for path in root.rglob("*"):
    if not path.is_file() or ".git" in path.parts or ".github" in path.parts: 
        continue
    h = hashlib.sha256(path.read_bytes()).hexdigest()
    if h in seen:
        path.unlink()
        deleted += 1
        print(f"Deleted duplicate: {path}")
        continue
    seen[h] = path
    try:
        data = path.read_bytes()
        enc = chardet.detect(data)["encoding"] or "utf-8"
        text = data.decode(enc, errors="replace")
        path.write_text(text, encoding="utf-8", newline="\n")
        converted += 1
    except Exception as e:
        print(f"::warning:: {path} {e}")
print(f"Deleted {deleted} duplicates, converted {converted} files to UTF-8.")
PY
      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --cached --quiet || (git commit -m "cleanup: remove duplicates, normalize utf-8" && git push)
