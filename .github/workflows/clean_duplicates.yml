name: Auto-clean Duplicates: Keep Most Relevant

on:
  workflow_dispatch:

jobs:
  clean_duplicates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Remove duplicates (max smart)
        run: |
          find . -type f -exec sha256sum {} \; | sort > all_sha.txt
          cut -d' ' -f1 all_sha.txt | uniq -d > dupesha.txt
          if [ -s dupesha.txt ]; then
            while read hash; do
              grep "^$hash" all_sha.txt | while read line; do
                fname="$(echo $line | cut -d' ' -f3-)"
                version="$(echo $fname | sed -n 's/.*(\([0-9]\+\)).*/\1/p')"
                [ -z "$version" ] && version=0
                size="$(stat -c %s "$fname")"
                mtime="$(stat -c %Y "$fname")"
                echo "$version $size $mtime $fname" >> group_$hash.txt
              done
              # приоритет: max version > max size > latest mtime
              sort -nr group_$hash.txt > sorted_$hash.txt
              keep="$(head -1 sorted_$hash.txt | awk '{print $4}')"
              awk -v keep="$keep" '$4 != keep {print $4}' sorted_$hash.txt >> deletelist.txt
              rm -f group_$hash.txt sorted_$hash.txt
            done < dupesha.txt
            sort -u deletelist.txt > todelete.txt
            while read f; do
              rm -f "$f"
            done < todelete.txt
          fi
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Smart dedupe: keep latest, largest, most relevant file"
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Clean duplicates, keep only most relevant version"
          title: "[AUTO] Remove file duplicates (max criteria)"
          body: |
            PR generated by GitHub Actions. 
            In each duplicate group, only the file with max version in name, largest size, or latest modification date is kept. 
            Please review and merge for optimal, clean repo.  
