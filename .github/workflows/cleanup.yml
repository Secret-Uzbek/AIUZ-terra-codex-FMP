name: Cleanup Repository

on:
  workflow_dispatch:
  push:

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Remove duplicate files by content
        run: |
          echo "Searching for duplicate files..."
          # создаём временный список с контрольными суммами
          find . -type f ! -path "./.git/*" -exec sha256sum {} + | sort > allfiles.txt
          # выделяем повторяющиеся хэши
          awk '{print $1}' allfiles.txt | uniq -d > duplicates.txt
          # если нашли дубли — удалить все, кроме первого экземпляра
          while read -r hash; do
            files=($(grep "$hash" allfiles.txt | awk '{print $2}'))
            if [ ${#files[@]} -gt 1 ]; then
              echo "Duplicate group: ${files[@]}"
              for ((i=1; i<${#files[@]}; i++)); do
                rm -f "${files[$i]}"
                echo "Removed ${files[$i]}"
              done
            fi
          done < duplicates.txt
          rm -f allfiles.txt duplicates.txt

      - name: Convert all text files to UTF-8
        run: |
          echo "Converting file encodings to UTF-8..."
          sudo apt-get update -qq
          sudo apt-get install -y dos2unix recode || true
          find . -type f ! -path "./.git/*" -print0 | while IFS= read -r -d '' file; do
            if file "$file" | grep -q "text"; then
              dos2unix "$file" 2>/dev/null || true
              recode UTF-8 "$file" 2>/dev/null || true
              echo "Converted $file"
            fi
          done

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add .
          git commit -m "Clean duplicates and convert encodings to UTF-8" || echo "No changes to commit"
          git push
